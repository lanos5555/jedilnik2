<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jedilni list - Femec, Gastro House in Vinka</title>

  <!-- Preconnects2 -->
  <link rel="preconnect" href="https://api.allorigins.win"/>
  <link rel="preconnect" href="http://www.femec.si"/>
  <link rel="preconnect" href="https://www.gastrohouse.si"/>
  <link rel="preconnect" href="https://www.vinka.si"/>

  <!-- CRITICAL CSS (first paint) -->
  <style id="critical-css">
    :root { --brand:#5dade2; --ok:#2ecc71; --ink:#2c3e50; }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; text-align: center; background:#f4f7f6; margin:0; padding:20px 10px; color:#333; overflow-x:hidden; }
    h1 { margin:20px 0 30px; color:var(--ink); font-weight:600; font-size:2rem; }
    #restaurant-switcher { margin: 20px auto; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; max-width: 680px; }
    .daysbutton{ display:inline-block; margin:5px; padding:12px 20px; background:var(--brand); color:#fff; cursor:pointer; border:none; border-radius:8px; font-size:1rem; font-weight:500; transition:background .15s ease, transform .15s ease; box-shadow:0 2px 4px rgba(0,0,0,.08) }
    .daysbutton:hover{ background:#3498db; transform:translateY(-1px) }
    .daysbutton.active{ background:var(--ok)!important; box-shadow:0 4px 10px rgba(46,204,113,.28) }
    #refresh-button{ background:#A8E6CF; color:var(--ink) }
    #refresh-button:hover{ background:#81D4A3 }
    #days{ margin:20px auto; display:flex; justify-content:center; gap:8px; flex-wrap:wrap; max-width:760px }
    .menu{ margin:20px auto 0; padding:20px; background:#fff; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.08); width:92%; max-width:760px; display:none; text-align:left; min-height:200px }

    /* Loader + skeleton */
    .loader-container{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; margin:10px auto 18px; padding:10px; min-height:120px }
    .loader-text{ font-size:1rem; color:#555; font-weight:500 }
    .loader-icon-wrapper{ font-size:2.2rem; display:inline-block; animation:pulseEmoji 1.4s ease-in-out infinite }
    @keyframes pulseEmoji{ 0%,100%{ transform:scale(1)} 50%{ transform:scale(1.15)} }
    .skeleton-dish{ background:#e9ecef; background-image:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.45) 50%, rgba(255,255,255,0) 100%); background-size:200% 100%; border-radius:8px; padding:14px; margin-bottom:12px; height:72px; animation:shimmer 1.5s infinite linear }
    .skeleton-dish .skeleton-line{ background:#cfd4da; height:14px; margin-bottom:8px; border-radius:4px }
    .skeleton-dish .skeleton-line.short{ width:60% }
    @keyframes shimmer{ 0%{ background-position:200% 0 } 100%{ background-position:-200% 0 } }
  </style>

  <!-- NON-CRITICAL CSS (lazy) -->
  <style>
    .day-heading{ background:var(--brand); color:#fff; padding:14px; border-radius:8px; margin-bottom:18px; text-align:center }
    .day-heading h2{ margin:0; font-size:1.2rem; font-weight:600 }
    .dish{ background:#ecf0f1; border-radius:8px; padding:14px; margin-bottom:12px; box-shadow:0 2px 5px rgba(0,0,0,.05); transition:transform .15s ease, box-shadow .15s ease }
    .dish:hover{ transform:translateY(-2px); box-shadow:0 4px 10px rgba(0,0,0,.1) }
    .dish h4{ font-size:1.05rem; margin:0 0 6px; display:flex; align-items:center; font-weight:600; color:var(--ink) }
    .dish h4 span.emoji-icon{ font-size:1.25rem; margin-right:10px; min-width:28px; display:inline-block; text-align:center }
    .dish p{ margin:4px 0 0; font-size:.95rem; color:#555; line-height:1.55; white-space:pre-line }
    .side-dish{ padding-left:20px; font-style:italic; color:#777 }
  </style>
</head>
<body>
  <h1>Jedilni list</h1>

  <div id="restaurant-switcher">
    <div id="femec-button" class="daysbutton active">Femec</div>
    <div id="gastro-button" class="daysbutton">Gastro House</div>
    <div id="vinka-button" class="daysbutton">Vinka</div>
    <div id="refresh-button" class="daysbutton">Osveži</div>
  </div>

  <div id="days"></div>
  <div id="menu" class="menu"></div>

  <script defer>
  // ====== PERFORMANCE FOCUS: instant cached render + SWR revalidate, parsed-data cache, timeouts, and lighter DOM work ======
  const PROXY = "https://api.allorigins.win/raw?url=";
  const FEMEC_URL = "http://www.femec.si/";
  const GASTRO_URL = "https://www.gastrohouse.si/index.php/tedenska-ponudba";
  const VINKA_URL = "https://www.vinka.si/malice-in-kosila.html";

  const TTL_MS = 15 * 60 * 1000; // 15 min logical freshness
  const FETCH_TIMEOUT_MS = 6500;  // abort slow requests
  const RETRIES = 1;              // one retry after timeout

  const daysSlo = { ponedeljek:"Ponedeljek", torek:"Torek", sreda:"Sreda", cetrtek:"Četrtek", petek:"Petek" };
  let currentRestaurant = "femec";
  let currentActiveDay = null;

  // in-memory parsed caches to avoid repeated DOM parsing
  let femecParsed = null; // { dayKey -> [{name, sides, type}] }
  let gastroParsed = null; // { tabs: [name], dishesByTabIndex: {i: [{name, sides}]} }
  let vinkaParsed = null; // HTML string already formatted

  // Loader state
  let loaderInterval = null, currentLoaderIconIndex = 0;
  const loaderIcons = ["🍕","🍔","🍣","🍜","🍝","🥗","🍦","🌮","🍩","🍰","🍿","🥪","🍤","🍖","🍗"]; 

  // ============ Utils ============
  const q = (sel, root=document) => root.querySelector(sel);
  const qa = (sel, root=document) => [...root.querySelectorAll(sel)];

  function makeKey(key){ return `menus:${key}` }
  function now(){ return Date.now() }

  function getCache(key){
    try{ const s = localStorage.getItem(makeKey(key)); if(!s) return null; const v = JSON.parse(s); return v; }catch{ return null }
  }
  function setCache(key, value){
    try{ localStorage.setItem(makeKey(key), JSON.stringify(value)) }catch{}
  }
  function setParsedCache(key, value){
    try{ sessionStorage.setItem(makeKey("parsed:"+key), JSON.stringify(value)) }catch{}
  }
  function getParsedCache(key){
    try{ const s = sessionStorage.getItem(makeKey("parsed:"+key)); return s? JSON.parse(s): null }catch{ return null }
  }

  function withTimeout(promise, ms){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), ms);
    return Promise.race([
      fetch(promise, { signal: ctrl.signal }),
      new Promise((_,rej)=>ctrl.signal.addEventListener('abort', ()=>rej(new Error('timeout'))))
    ]).finally(()=>clearTimeout(t));
  }

  function proxied(url, bust=false){
    const u = new URL(url);
    if(bust){ u.searchParams.set('_', String(Date.now())); }
    return PROXY + encodeURIComponent(u.toString());
  }

  // Stale-While-Revalidate fetch: show cached instantly; revalidate in background and update if content changed.
  async function fetchSWR(urlKey, url, {ttl=TTL_MS, bustOnRevalidate=false}={}){
    const cached = getCache(urlKey);
    let html = cached?.html || null;
    let isFresh = cached && (now() - cached.timestamp < ttl);

    // 1) immediate return of cached content to render instantly
    if(html){
      // trigger background revalidate only if stale
      if(!isFresh) revalidate();
      return { html, fromCache: true };
    }
    // 2) no cache – do network fetch fast path
    try{
      const resp = await fetch(proxied(url, false), { cache: 'no-store' });
      if(!resp.ok) throw new Error('network');
      html = await resp.text();
      setCache(urlKey, { html, timestamp: now() });
      // background revalidate shortly (to beat proxy stale cases) but don't block paint
      setTimeout(()=>revalidate(), 0);
      return { html, fromCache: false };
    }catch(e){
      // last resort – return what we have (null) and let caller handle
      return { html: null, fromCache: false };
    }

    async function revalidate(){
      let attempt = 0; let ok=false;
      while(attempt<=RETRIES && !ok){
        try{
          const resp = await fetch(proxied(url, bustOnRevalidate || attempt>0), { cache:'no-store' });
          if(!resp.ok) throw new Error('network');
          const fresh = await resp.text();
          if(!cached || fresh !== cached.html){
            setCache(urlKey, { html: fresh, timestamp: now() });
            onRevalidated(urlKey, fresh); // live update if viewing this restaurant
          }else{
            setCache(urlKey, { html: cached.html, timestamp: now() }); // refresh timestamp
          }
          ok=true;
        }catch{ attempt++; }
      }
    }
  }

  // Live update after revalidate if user is on that view
  function onRevalidated(key, freshHtml){
    if(currentRestaurant==='femec' && key==='femec'){
      femecParsed = parseFemec(freshHtml); setParsedCache('femec', femecParsed);
      if(currentActiveDay) renderFemec(currentActiveDay);
    }else if(currentRestaurant==='gastro' && key==='gastro'){
      gastroParsed = parseGastro(freshHtml); setParsedCache('gastro', gastroParsed);
      renderGastro(0);
    }else if(currentRestaurant==='vinka' && key==='vinka'){
      vinkaParsed = parseVinka(freshHtml); setParsedCache('vinka', vinkaParsed);
      renderVinka();
    }
  }

  // ======= UI helpers =======
  function showLoader(message="Nalaganje jedilnika...", showSkeleton=false){
    clearInterval(loaderInterval); const menuDiv = q('#menu');
    let skeleton=""; if(showSkeleton){ for(let i=0;i<3;i++){ skeleton += `<div class="skeleton-dish"><div class="skeleton-line"></div><div class="skeleton-line short"></div></div>`; } }
    menuDiv.innerHTML = `<div class="loader-container"><span class="loader-text">${message}</span><div class="loader-icon-wrapper"><span id="loader-icon-animated">${loaderIcons[currentLoaderIconIndex]}</span></div></div>${skeleton}`;
    menuDiv.style.display='block';
    const icon = q('#loader-icon-animated');
    if(icon){ loaderInterval = setInterval(()=>{ currentLoaderIconIndex=(currentLoaderIconIndex+1)%loaderIcons.length; icon.textContent=loaderIcons[currentLoaderIconIndex]; }, 900); }
  }

  function renderHeading(txt){ return `<div class="day-heading"><h2>${txt}</h2></div>` }
  function clearLoader(){ if(loaderInterval){ clearInterval(loaderInterval); loaderInterval=null; } }

  function getFormattedDateForWeekday(dayKey){
    if(!dayKey) return ""; const map={ ponedeljek:1, torek:2, sreda:3, cetrtek:4, petek:5 };
    const idx = map[dayKey]; if(idx===undefined) return "";
    const d = new Date(); let wd=d.getDay(); if(wd===0) wd=7; const monday=new Date(d); monday.setDate(d.getDate()-(wd-1));
    const target=new Date(monday); target.setDate(monday.getDate()+(idx-1));
    let s = target.toLocaleDateString('sl-SI', { day:'numeric', month:'long' });
    return s.replace(/(\d+\. )([a-zčšžđ])/,(m,p1,p2)=>p1+p2.toUpperCase());
  }

  function emojiFor(dish){
    const nameLower = dish.toLowerCase();
    const map=[
      {k:"tortilija",e:"🌯"},{k:"tortilja",e:"🌯"},
      {k:"lignji",e:"🦑"},{k:"lignje",e:"🦑"},
      {k:"pizza",e:"🍕"},{k:"pica",e:"🍕"},
      {k:"burger",e:"🍔"},{k:"sendvič",e:"🥪"},
      {k:"lazanja",e:"🍝"},{k:"špageti",e:"🍝"},{k:"makaroni",e:"🍝"},{k:"tortelini",e:"🍝"},{k:"testenine",e:"🍝"},
      {k:"njoki",e:"🥔"},
      {k:"rižota",e:"🍚"},{k:"riž",e:"🍚"},
      {k:"solatni krožnik",e:"🥗"},{k:"solatni bar",e:"🥗"},{k:"solata",e:"🥗"},{k:"solato",e:"🥗"},
      {k:"piščan",e:"🍗"},{k:"puran",e:"🍗"},
      {k:"dunajski",e:"🥩"},{k:"biftek",e:"🥩"},
      {k:"gove",e:"🐄"},
      {k:"svinjs",e:"🐖"},{k:"pečenka",e:"🍖"},{k:"zrezek",e:"🥩"},{k:"kotlet",e:"🥩"},{k:"krača",e:"🍖"},
      {k:"čevap",e:"🥩"},{k:"pleskav",e:"🥩"},{k:"ražnji",e:"🍢"},
      {k:"golaž",e:"🍲"},{k:"obara",e:"🍲"},{k:"enolonč",e:"🍲"},{k:"pasulj",e:"🍲"},
      {k:"juha",e:"🥣"},{k:"jetrca",e:"🍳"},
      {k:"klobasa",e:"🌭"},{k:"hrenovka",e:"🌭"},
      {k:"jajc",e:"🥚"},{k:"omleta",e:"🍳"},{k:"fritata",e:"🍳"},{k:"ocvrt",e:"🍳"},
      {k:"sir",e:"🧀"},{k:"mozzarella",e:"🧀"},
      {k:"pečen",e:"🍖"},{k:"na žaru",e:"🔥"},
      {k:"morski sadeži",e:"🦞"},{k:"škampi",e:"🦐"},
      {k:"losos",e:"🐟"},{k:"oslič",e:"🐟"},{k:"postrv",e:"🐟"},{k:"sardel",e:"🐟"},{k:"skuša",e:"🐟"},{k:"brancin",e:"🐟"},{k:"orada",e:"🐟"},{k:"bakalar",e:"🐟"},{k:"riba",e:"🐟"},
      {k:"krompir",e:"🥔"},{k:"pire",e:"🥔"},
      {k:"zelenjav",e:"🥕"},{k:"bučke",e:"🥒"},{k:"paprika",e:"🌶️"},{k:"paradižnik",e:"🍅"},
      {k:"brokoli",e:"🥦"},{k:"cvetača",e:"🥦"},
      {k:"grah",e:"🫛"},{k:"fižol",e:"🫘"},{k:"leča",e:"🥣"},
      {k:"sladica",e:"🍰"},{k:"torta",e:"🍰"},{k:"palačinke",e:"🥞"},{k:"zavitek",e:"🥧"},{k:"štrudelj",e:"🥧"},{k:"sadje",e:"🍓"},{k:"jogurt",e:"🍦"},{k:"krema",e:"🍮"}
    ];
    for(const it of map){ if(nameLower.includes(it.k)) return it.e; } return "🍴";
  }

  // ======= Parsing (done once per source, then reused) =======
  function parseFemec(html){
    const out={}; const doc=new DOMParser().parseFromString(html,'text/html');
    for(const key of Object.keys(daysSlo)){
      const sec = doc.getElementById(key); if(!sec){ continue }
      const items = qa('.menucontent p', sec); const dishes=[];
      let current=null; let weekly=false;
      for(const el of items){ const t=el.textContent.trim(); if(!t) continue;
        const low=t.toLowerCase();
        if(low.includes('tedensk ponudba')){ if(current) dishes.push(current); dishes.push({name:'TEDENSKA PONUDBA', type:'special_header', sides:[]}); current=null; weekly=true; continue; }
        if(low.includes('samopostrežni solatni bar')){ if(current && !weekly){ current.sides.push(t); } else { if(current) dishes.push(current); dishes.push({name:t, type:'normal', sides:[]}); current=null; } continue; }
        if(current) dishes.push(current); current={name:t, type:'normal', sides:[]};
      }
      if(current) dishes.push(current); out[key]=dishes;
    }
    return out; // { dayKey: [dish] }
  }

  function parseGastro(html){
    const doc=new DOMParser().parseFromString(html,'text/html');
    const tabs=qa('.sprocket-tabs-nav li', doc).map(li=>li.textContent.trim());
    const panels=qa('.sprocket-tabs-panel', doc);
    const dishesByTabIndex={};
    panels.forEach((p,idx)=>{
      const list=p.querySelector('.futr ul');
      const arr=[]; if(list){ qa('li', list).forEach(li=>{ const text=li.textContent.trim(); if(!text) return;
        if(li.querySelector('strong') || (text.toUpperCase()===text && text.length>5 && !text.includes(','))){ arr.push({name:text,sides:[]}); }
        else { if(arr.length===0) arr.push({name:text,sides:[]}); else arr[arr.length-1].sides.push(text); }
      }); }
      dishesByTabIndex[idx]=arr;
    });
    return { tabs, dishesByTabIndex };
  }

  function parseVinka(html){
    const doc=new DOMParser().parseFromString(html,'text/html');
    const content=doc.querySelector('div.col-md-9[role="content"]');
    if(!content) return `<p>Glavni vsebinski del za Vinko ni bil najden na strani.</p>`;
    let pWithMenu=null; for(const p of qa('p', content)){ const t=p.innerText.toLowerCase(); if(t.includes('dnevna ponudba') && (t.includes('naše stalnice') || t.includes('jed na žlico') || t.includes('za vegeterijance'))) { pWithMenu=p; break; } }
    if(!pWithMenu){ return `<p>Vsebina menija za Vinko ni najdena v pričakovani obliki.</p>`; }
    const htmlContent = pWithMenu.innerHTML;
    const mStal='Naše stalnice:'; const mDnev='Dnevna ponudba:'; const mVeg='Za vegeterijance:'; const mZlic='Jed na žlico:';
    const iS=htmlContent.indexOf(mStal), iD=htmlContent.indexOf(mDnev), iV=htmlContent.indexOf(mVeg), iZ=htmlContent.indexOf(mZlic);
    const clean = s=>s.replace(/<br\s*\/?>/gi,'\n').replace(/<[^>]+>/g,'').trim();
    if(iS!==-1 && iD!==-1 && iV!==-1 && iZ!==-1 && iS<iD && iD<iV && iV<iZ){
      const bD=clean(htmlContent.substring(iD+mDnev.length, iV));
      const bS=clean(htmlContent.substring(iS+mStal.length, iD));
      const bV=clean(htmlContent.substring(iV+mVeg.length, iZ));
      const bZ=clean(htmlContent.substring(iZ+mZlic.length));
      return `
        <div class="dish"><h4><span class="emoji-icon">${emojiFor(mDnev)}</span> ${mDnev.toUpperCase()}</h4><p>${bD}</p></div>
        <div class="dish"><h4><span class="emoji-icon">${emojiFor(mStal)}</span> ${mStal.toUpperCase()}</h4><p>${bS}</p></div>
        <div class="dish"><h4><span class="emoji-icon">🌿</span> ${mVeg.toUpperCase()}</h4><p>${bV}</p></div>
        <div class="dish"><h4><span class="emoji-icon">🥣</span> ${mZlic.toUpperCase()}</h4><p>${bZ}</p></div>
      `;
    }
    // fallback: whole paragraph text with line breaks preserved
    const tmp = new DOMParser().parseFromString(htmlContent,'text/html');
    return `<div class="dish"><p>${(tmp.body.textContent||htmlContent.replace(/<br\s*\/?>/gi,'\n')).trim()}</p></div>`;
  }

  // ======= Rendering =======
  function renderFemec(dayKey){
    clearLoader(); const menu=q('#menu');
    const dayName=daysSlo[dayKey]||dayKey; const heading=`Femec - ${dayName}, ${getFormattedDateForWeekday(dayKey)} (11:00 - 14:00)`;
    const list=femecParsed?.[dayKey];
    if(!list || list.length===0){ menu.innerHTML = renderHeading(heading)+`<p>Meni za ta dan ni na voljo.</p>`; return; }
    const html=list.map(d=>{
      if(d.type==='special_header') return `<div class="dish"><h4>${d.name}</h4></div>`;
      const emoji=emojiFor(d.name);
      return `<div class="dish"><h4><span class="emoji-icon">${emoji}</span> ${d.name}</h4>${(d.sides||[]).map(s=>`<p class="side-dish">${s}</p>`).join('')}</div>`;
    }).join('');
    menu.innerHTML = renderHeading(heading)+html; menu.style.display='block';
  }

  function renderGastro(tabIndex){
    clearLoader(); const menu=q('#menu');
    const today=new Date(); const dateStr=today.toLocaleDateString('sl-SI',{day:'numeric',month:'long'});
    const opening='08:00-16:00'; const tabName=(gastroParsed?.tabs?.[tabIndex])||'Današnji meni';
    const heading=`Gastro House - ${tabName}, ${dateStr} (${opening})`;
    const items=gastroParsed?.dishesByTabIndex?.[tabIndex]||[];
    if(items.length===0){ menu.innerHTML=renderHeading(heading)+`<p>Meni ni na voljo.</p>`; return; }
    const html=items.map(d=>`<div class="dish"><h4><span class="emoji-icon">${emojiFor(d.name)}</span> ${d.name}</h4>${d.sides.map(s=>`<p class="side-dish">${s}</p>`).join('')}</div>`).join('');
    menu.innerHTML=renderHeading(heading)+html; menu.style.display='block';
  }

  function renderGastroDays(){
    const cont=q('#days'); cont.innerHTML='';
    (gastroParsed?.tabs||[]).forEach((name, idx)=>{
      const b=document.createElement('div'); b.className='daysbutton'; b.textContent=name; b.onclick=()=>{ qa('#days .daysbutton').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderGastro(idx); };
      cont.appendChild(b); if(idx===0) b.classList.add('active');
    });
  }

  function renderVinka(){
    clearLoader(); const menu=q('#menu');
    const todayIdx=new Date().getDay(); const key=(todayIdx>=1 && todayIdx<=5)? Object.keys(daysSlo)[todayIdx-1] : 'ponedeljek';
    const heading=`Vinka - ${daysSlo[key]||'Današnji meni'}, ${getFormattedDateForWeekday(key)} (10:30 - 15:00)`;
    menu.innerHTML = renderHeading(heading) + (vinkaParsed||'<p>Napaka pri nalaganju jedilnika za Vinka.</p>');
    menu.style.display='block';
  }

  // ======= Controller =======
  const femecBtn = q('#femec-button');
  const gastroBtn = q('#gastro-button');
  const vinkaBtn = q('#vinka-button');
  const refreshBtn = q('#refresh-button');

  let dayButtons = {};
  function buildFemecDays(){
    const cont=q('#days'); cont.innerHTML=''; dayButtons={};
    for(const key of Object.keys(daysSlo)){
      const b=document.createElement('div'); b.className='daysbutton'; b.textContent=daysSlo[key]; b.onclick=()=>{ qa('#days .daysbutton').forEach(x=>x.classList.remove('active')); b.classList.add('active'); currentActiveDay=key; renderFemec(key); };
      cont.appendChild(b); dayButtons[key]=b;
    }
  }

  function setActiveHeader(btn){ [femecBtn,gastroBtn,vinkaBtn].forEach(b=>b.classList.remove('active')); btn?.classList.add('active'); }

  async function showFemec(){
    currentRestaurant='femec'; setActiveHeader(femecBtn); buildFemecDays();
    showLoader('Nalagam meni za Femec...', true);
    // load parsed from session (fast), otherwise fetch and parse
    femecParsed = getParsedCache('femec');
    if(!femecParsed){ const {html}= await fetchSWR('femec', FEMEC_URL, { ttl: TTL_MS }); if(html) { femecParsed = parseFemec(html); setParsedCache('femec', femecParsed); } }
    const today = new Date().getDay(); const defKey = (today>=1 && today<=5) ? Object.keys(daysSlo)[today-1] : 'ponedeljek';
    currentActiveDay = defKey; if(dayButtons[defKey]) dayButtons[defKey].classList.add('active');
    renderFemec(defKey);
    // background preloads
    idleLoadOthers();
  }

  async function showGastro(){
    currentRestaurant='gastro'; setActiveHeader(gastroBtn); q('#days').innerHTML=''; showLoader('Nalagam meni za Gastro House...', true);
    gastroParsed = getParsedCache('gastro');
    if(!gastroParsed){ const {html}= await fetchSWR('gastro', GASTRO_URL, { ttl: TTL_MS }); if(html){ gastroParsed = parseGastro(html); setParsedCache('gastro', gastroParsed); } }
    renderGastroDays(); renderGastro(0);
    idleLoadOthers();
  }

  async function showVinka(){
    currentRestaurant='vinka'; setActiveHeader(vinkaBtn); q('#days').innerHTML=''; showLoader('Nalagam meni za Vinka...', true);
    vinkaParsed = getParsedCache('vinka');
    if(!vinkaParsed){ const {html}= await fetchSWR('vinka', VINKA_URL, { ttl: TTL_MS }); if(html){ vinkaParsed = parseVinka(html); setParsedCache('vinka', vinkaParsed); } }
    renderVinka();
    idleLoadOthers();
  }

  function idleLoadOthers(){
    const run = ()=>{
      if(currentRestaurant!=='femec' && !femecParsed){ fetchSWR('femec', FEMEC_URL, { ttl: TTL_MS }).then(({html})=>{ if(html){ femecParsed=parseFemec(html); setParsedCache('femec', femecParsed); } }); }
      if(currentRestaurant!=='gastro' && !gastroParsed){ fetchSWR('gastro', GASTRO_URL, { ttl: TTL_MS }).then(({html})=>{ if(html){ gastroParsed=parseGastro(html); setParsedCache('gastro', gastroParsed); } }); }
      if(currentRestaurant!=='vinka' && !vinkaParsed){ fetchSWR('vinka', VINKA_URL, { ttl: TTL_MS }).then(({html})=>{ if(html){ vinkaParsed=parseVinka(html); setParsedCache('vinka', vinkaParsed); } }); }
    };
    if('requestIdleCallback' in window){ requestIdleCallback(run, { timeout: 1200 }); } else { setTimeout(run, 0); }
  }

  function refreshAll(){
    // hard refresh: clear both raw + parsed caches, then reload current view
    ['femec','gastro','vinka'].forEach(k=>{ try{ localStorage.removeItem(makeKey(k)); sessionStorage.removeItem(makeKey('parsed:'+k)); }catch{} });
    femecParsed=gastroParsed=vinkaParsed=null;
    if(currentRestaurant==='femec') showFemec(); else if(currentRestaurant==='gastro') showGastro(); else showVinka();
    // also kick background loads to warm caches again
    idleLoadOthers();
  }

  // ======= Init =======
  femecBtn.onclick = ()=>{ if(currentRestaurant==='femec' && q('#days .daysbutton.active')) return; showFemec(); };
  gastroBtn.onclick = ()=>{ if(currentRestaurant==='gastro' && q('#days .daysbutton.active')) return; showGastro(); };
  vinkaBtn.onclick = ()=>{ if(currentRestaurant==='vinka' && vinkaParsed) return; showVinka(); };
  refreshBtn.onclick = refreshAll;

  // First paint as Femec (fast cached), others preloaded idle
  showFemec();
  </script>
</body>
</html>
